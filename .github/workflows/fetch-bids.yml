name: Fetch NJ Bids
on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * *"   # 10:00 UTC daily (~6:00 AM ET)

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      # 🧱 1. Checkout code
      - uses: actions/checkout@v4

      # 🐍 2. Setup Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 📦 3. Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 🔑 4. Decode the Google Service Account key
      - name: Write Google Service Account key (base64 via OpenSSL)
        run: |
          echo "${{ secrets.GOOGLE_SA_JSON_B64 }}" | openssl base64 -A -d -out service_account.json

      # 🧮 5. Validate the key
      - name: Validate SA JSON
        run: |
          python - <<'PY'
          import json, os, sys
          p = 'service_account.json'
          if not os.path.exists(p):
              print('❌ service_account.json missing'); sys.exit(2)
          data = open(p, 'rb').read()
          print(f'Key file bytes: {len(data)}')
          if not data:
              print('❌ File empty'); sys.exit(3)
          if data[:1] != b'{':
              print('❌ Key does not start with "{"'); sys.exit(4)
          try:
              j = json.loads(data.decode())
          except Exception as e:
              print('❌ JSON parse error:', e); sys.exit(5)
          print('✅ JSON loaded successfully for:', j.get('client_email'))
          PY

      # 🗂️ 6. Show repository tree (diagnostic)
      - name: Show repo tree
        run: |
          echo "📁 Current working directory:"
          pwd
          echo
          echo "📄 Listing files up to depth 3:"
          find . -maxdepth 3 \( -name "fetch_*.py" -o -name "utils_common.py" -o -name "requirements.txt" \) | sort

      # 🧩 7. Run each scraper (resilient)
      - name: Fetch DPMC
        run: |
          if [ -f fetch_dpmc.py ]; then
            python fetch_dpmc.py
          else
            echo "⚠️ fetch_dpmc.py not found; skipping."
          fi
        continue-on-error: true

      - name: Fetch NJDOT
        run: |
          if [ -f fetch_njdot.py ]; then
            python fetch_njdot.py
          else
            echo "⚠️ fetch_njdot.py not found; skipping."
          fi
        continue-on-error: true

      - name: Fetch NJTA
        run: |
          if [ -f fetch_njta.py ]; then
            python fetch_njta.py
          else
            echo "⚠️ fetch_njta.py not found; skipping."
          fi
        continue-on-error: true
